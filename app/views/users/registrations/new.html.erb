<div class="row">
  <section class="col-12 col-lg-8 col-xl-6 login-box">
    <%= form_for resource,
                 as: resource_name,
                 url: registration_path(resource_name),
                 data: { controller: "user-form", action: "submit->user-form#submit", turbo: false } do |f|  %>
      <%= render "users/shared/error_messages", resource: resource %>
      <article>
        <h3>필수입력 사항</h3>
        <div class="card">
          <div class="card-body">
            <div class="form-group col-12">
              <%= f.label :name, :class => 'form-label' %>
              <%= f.text_field :name, :class => 'form-control-lg form-control', :required => 'required' %>
            </div>
            <div class="form-group col-12">
              <%= f.label :email, :class => 'form-label' %>
              <%= f.email_field :email, :class => 'form-control-lg form-control', :required => 'required' %>
            </div>
            <div class="form-group col-12">
              <%= f.label :password, :class => 'form-label' %>
              <%= f.password_field :password, :class => 'form-control-lg form-control', :required => 'required' %>
            </div>
            <div class="form-group col-12">
              <%= f.label :description, :class => 'form-label' %>
              <%= f.text_field :description, :class => 'form-control-lg form-control', :required => 'required' %>
            </div>
          </div>
        </div>
      </article>
      <article>
        <h3>선택입력 사항</h3>
        <div class="card">
          <div class="card-body">
            <div class="form-group col-12">
              <%= f.label :photo, :class => 'form-label' %>
              <% if resource.photo? %>
                <%= image_tag resource.photo.small_thumb.url %>
              <% end %>
              <div class="custom-file">
                <%= f.file_field :photo, class: "custom-file-input", data: { "user-form-target": "photo" } %>
                <label class="form-control-lg custom-file-label" for="customFile" data-browse="<%=t(:browse) %>"><%=t(:choose_file) %></label>
              </div>
              <%= f.hidden_field :photo_cache %>
            </div>
            <div class="form-group col-12">
              <%= f.label :url, :class => 'form-label' %>
              <%= f.url_field :url,
                              class: 'form-control-lg form-control',
                              placeholder: "http://www.example.com",
                              data: { "user-form-target": "url", action: "focus->user-form#focusUrl" } %>
            </div>
          </div>
        </div>
      </article>
      <% if Rails.env.production? %>
        <div id="turnstile-container" class="mt-3"></div>
      <% end %>
      <div class="d-grid gap-2 mt-3">
        <%= form.submit "저장",
                        id: "submit-btn",
                        class: "btn btn-lg btn-primary disabled" %>
      </div>
    <% end %>
  </section>
</div>
<% if Rails.env.production? %>
  <script>
      // Turnstile 렌더
      window.turnstileLoaded = function () {
          const el = document.getElementById("turnstile-container");
          if (!el) return;

          el.innerHTML = '';

          turnstile.render(el, {
              sitekey: "<%= ENV['TURNSTILE_SITE_KEY'] %>",
              callback: function () {
                  // Turnstile 성공 시 버튼 활성화
                  const btn = document.getElementById("submit-btn");
                  btn.classList.remove("disabled");
              }
          });
      };

      // disabled 스타일 클릭 시 안내 alert
      document.addEventListener("DOMContentLoaded", function() {
          const btn = document.getElementById("submit-btn");
          btn.addEventListener("click", function(e) {
              if (btn.classList.contains("disabled")) {
                  e.preventDefault(); // form submit 막기
                  alert("로봇 방지 인증을 먼저 완료해주세요.");
                  document.getElementById("turnstile-container")?.scrollIntoView({behavior:'smooth', block:'center'});
              }
          });
      });
  </script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=turnstileLoaded" async defer></script>
<% end %>